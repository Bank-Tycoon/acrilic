/*! Acrilic 30-11-2015 */
var AC=function(){"use strict";return window.log=console.log.bind(console),{ESC_KEY:27,TILESIZE:64,init:function(){this.Map.init({graphics:this.Graphics}),this.Interface.init({graphics:this.Graphics,dialog:this.Dialog}),this.Editor.init({"interface":this.Interface,map:this.Map})}}}();AC.Dialog=function(){"use strict";var a={elem:void 0,open:function(){this.elem.show()},close:function(){this.elem.hide()}},b=function(a,b){for(var c="",d=function(b,c){a.elem.on("click","#"+c,function(){b.action(a)})},e=0;e<b.length;e++){var f=b[e],g="btn-"+f.title.replace(/\s+/g,"-").toLowerCase();c+='<button id="'+g+'">'+f.title+"</button>",d(f,g)}return c};return{modal:function(c,d,e){var f=$.extend(!0,{},a),g=f.elem=$($("#tpl-dialog-overlay").html());return g.find(".btn-close").on("click",function(){f.close()}),g.find(".dialog-titlebar .title").html(c),g.find(".dialog-content").html(d),g.find(".dialog-button-panel").html(b(f,e)),$(document).on("keydown",function(a){a.which==AC.ESC_KEY&&f.close()}),$("body").append(g),f},confirm:function(a,b){var c=this;this.open("","<p>"+a+"</p>",[{title:"OK",action:function(){b(),c.close()}},{title:"Cancel",action:function(){c.close()}}])}}}(),AC.Editor=function(){"use strict";var a,b,c,d={},e={},f={};return{openMap:function(a,b){d[a]=currentMap=b},setTool:function(a){},setLayer:function(a){c=f[a]},initInterface:function(){var c=this;a.createDialogHandler({title:"New map",btnSelector:"#btn-file-new",templateSelector:"#tpl-dialog-file-new",buttonSet:[{title:"OK",action:function(a){var d=$("#field-file-new-name").val(),e=Number($("#field-file-new-width").val()),f=Number($("#field-file-new-height").val()),g=b.create(e,f);a.close(),c.openMap(d,g)}},{title:"Cancel",action:function(a){a.close()}}]}),a.createDialogHandler({title:"Import",btnSelector:"#btn-file-import",templateSelector:"#tpl-dialog-file-import",buttonSet:[{title:"Import",action:function(a){$("#field-file-import-map").val()}},{title:"Cancel",action:function(a){a.close()}}]}),a.createDialogHandler({title:"Export",btnSelector:"#btn-file-export",templateSelector:"#tpl-dialog-file-export",buttonSet:[{title:"Close",action:function(a){a.close()}}],initialize:function(){var a=JSON.stringify({a:3});$("#field-file-export-map").val(a)}}),a.createSwitchModeHandler(".btn-tool",{"btn-tool-pen":"pen","btn-tool-fill":"fill","btn-tool-eraser":"eraser"},function(a){c.setTool(a)}),a.createSwitchModeHandler(".btn-layer",{"btn-layer-bg":"bg","btn-layer-fg":"fg","btn-layer-event":"event"},function(a){c.setLayer(a)}),a.createTilesetPalette("#tileset-panel",{srcImage:"tilesets/ground-layer.png"}),a.createMapEditor("#map-panel",{action:function(a,b,c){var d=c||{};d.dragging}})},initTools:function(){e={pen:function(a){},fill:function(a){},eraser:function(a){}}},init:function(c){b=c.map,a=c["interface"],this.initInterface(),this.initTools()}}}(),AC.Graphics=function(){var a={draw:function(a,b,c){var d=this.width,e=this.height;this.ctx.drawImage(a,b,c,d,e,0,0,d,e)}};return{loadImage:function(a,b){var c=new Image;c.onload=function(){b(c,c.width,c.height)},c.src=a},createCanvas:function(b,c){var d=$.extend(!0,{},a),e=$("<canvas/>").attr("width",b).attr("height",c);return d.width=b,d.height=c,d.ctx=e.get(0).getContext("2d"),d.elem=e,d}}}(),AC.Interface=function(){"use strict";var a,b;return{createDialogHandler:function(b){var c=b||{},d=$(c.templateSelector).html(),e=a.modal(c.title,$(d),c.buttonSet);$(c.btnSelector).on("click",function(){e.open(),$.isFunction(c.initialize)&&c.initialize()})},createSwitchModeHandler:function(a,b,c){var d="active",e=$(a);e.on("click",function(a){e.removeClass(d);var f=$(this),g=f.attr("id"),h=b[g];f.addClass(d),c(h)}),e.first().trigger("click")},createTilesetPalette:function(a,c){var d,e=c||{},f=AC.TILESIZE,g=$(a),h="menu-tile-selected";b.loadImage(e.srcImage,function(a,c,e){for(var i=Math.floor(c/f),j=Math.floor(e/f),k=0;j>k;k++)for(var l=0;i>l;l++){var m=b.createCanvas(f,f);m.draw(a,l*f,k*f),m.elem.addClass("menu-tile").data("tilecode",0),g.append(m.elem)}g.on("click",".menu-tile",function(){var a=$(this);d&&d.removeClass(h),a.addClass(h),d=a}).find(".menu-tile:first").trigger("click")})},createMapEditor:function(a,b){var c=b||{},d=0,e=0,f=AC.TILESIZE,g=!1,h=$(a),i=$("<div/>").addClass("selection-cursor").css({width:f,height:f});h.append(i).on("mousemove",function(a){var b=h.offset().left,j=h.offset().top,k=h.scrollLeft()+$(document).scrollLeft(),l=h.scrollTop()+$(document).scrollTop(),m=a.pageX-b+k,n=a.pageY-j+l;m=0>m?0:m,n=0>n?0:n,d=parseInt(m/f),e=parseInt(n/f),i.css({left:d*f,top:e*f}),g&&c.action(d,e,{dragging:!0})}).on("mousedown",function(a){a.preventDefault(),g=!0,c.action(d,e)}),$(document).on("mouseup",function(){g=!1}),h.css("left",$("#tileset-panel-wrapper").width())},init:function(c){b=c.graphics,a=c.dialog}}}(),AC.Map=function(){var a,b={grid:[],canvas:void 0,setTile:function(){},render:function(a){}};return{create:function(c,d){for(var e=AC.TILESIZE,f=$.extend(!0,{},b),g=0;d>g;g++){f.grid.push([]);for(var h=0;c>h;h++)f.grid[g].push({id:0})}return f.canvas=a.createCanvas(c*e,d*e),f},init:function(b){a=b.graphics}}}(),function(){"use strict";AC.init()}();