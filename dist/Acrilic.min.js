/*! Acrilic 01-06-2016 */
var ac=function(){"use strict";var a={},b=function(){var a={};return{set:function(b,c){a[b]=c},get:function(b){return a[b]},has:function(b){return a.hasOwnProperty(b)},del:function(b){delete a[b]}}}();return{ESC_KEY:27,log:console.log.bind(console),error:console.error.bind(console),"export":function(b,c){a[b]={func:c,ref:void 0}},"import":function(c){var d;return a.hasOwnProperty(c)?(d=a[c],void 0===d.ref&&(d.ref=d.func(b),delete d.func),d.ref):void this.error("Module "+c+" doesn't exist.")}}}();ac["export"]("graphics",function(a){"use strict";var b={draw:function(a,b,c,d,e){var f=this.width,g=this.height;this.ctx.drawImage(a,b,c,f,g,d,e,f,g)}};return{loadImage:function(a,b){var c=new Image;c.onload=function(){b(c,c.width,c.height)},c.src=a},createCanvas:function(a,c){var d=$.extend(!0,{},b),e=$("<canvas/>").attr("width",a).attr("height",c);return d.width=a,d.height=c,d.ctx=e.get(0).getContext("2d"),d.elem=e,d}}}),ac["export"]("map",function(a){"use strict";var b=ac["import"]("graphics"),c={grid:[],elem:void 0,setTile:function(b,c,d){var e=a.get("TILESIZE");this.grid[d][c]=1,this.canvas.draw(b,0,0,c*e,d*e)},render:function(a){}};return{create:function(d,e){for(var f=a.get("TILESIZE"),g=$.extend(!0,{},c),h=0;e>h;h++){g.grid.push([]);for(var i=0;d>i;i++)g.grid[h].push({id:0})}return g.canvas=b.createCanvas(d*f,e*f),g.elem=$("<div/>").addClass(".map"),g.elem.append(g.canvas.elem),g},init:function(){}}}),ac["export"]("editor",function(){"use strict";var a,b,c,d=(ac["import"]("widget"),ac["import"]("map"),{}),e={};return{createMapEditor:function(a,b){var c=$(document),d=b||{},e=0,f=0,g=ac.TILESIZE,h=!1,i=$(a),j=$("<div/>").addClass("selection-cursor").css({width:g,height:g});return i.append(j).on("mousemove",function(a){var b=i.offset().left,k=i.offset().top,l=i.scrollLeft()+c.scrollLeft(),m=i.scrollTop()+c.scrollTop(),n=a.pageX-b+l,o=a.pageY-k+m;n=0>n?0:n,o=0>o?0:o,e=parseInt(n/g),f=parseInt(o/g),j.css("transform","translate("+e*g+"px, "+f*g+"px)"),h&&d.action(e,f,{dragging:!0})}).on("mousedown",function(a){a.preventDefault(),h=!0,d.action(e,f)}),c.on("mouseup",function(){h=!1}),i.css("left",$("#tileset-panel-wrapper").width()),i},openMap:function(b,e){a.append(e.elem),d[b]=c=e},setTool:function(a){},setLayer:function(a){b=e[a]}}}),ac["export"]("interface",function(){var a,b=ac["import"]("widget"),c=ac["import"]("editor"),d=(ac["import"]("dialog"),ac["import"]("tools")),e=ac["import"]("map"),f=ac["import"]("pallette"),g=function(){f.init("#tileset-panel",{srcImage:"tilesets/ground-layer.png",action:function(a){_currentPaletteTile=a}})},h=function(){a=c.createMapEditor("#map-panel",{action:function(a,b,c){var d=c||{};d.dragging;_currentMap&&_currentMap.setTile(_currentPaletteTile,a,b)}})},i=function(){var a=this;b.createDialogHandler({title:"New map",btnSelector:"#btn-file-new",templateSelector:"#tpl-dialog-file-new",buttonSet:[{title:"OK",action:function(b){var c=$("#field-file-new-name").val(),d=Number($("#field-file-new-width").val()),f=Number($("#field-file-new-height").val());_currentMap||(b.close(),a.openMap(c,e.create(d,f)))}},{title:"Cancel",action:function(a){a.close()}}]}),b.createDialogHandler({title:"Import",btnSelector:"#btn-file-import",templateSelector:"#tpl-dialog-file-import",buttonSet:[{title:"Import",action:function(a){$("#field-file-import-map").val()}},{title:"Cancel",action:function(a){a.close()}}]}),b.createDialogHandler({title:"Export",btnSelector:"#btn-file-export",templateSelector:"#tpl-dialog-file-export",buttonSet:[{title:"Close",action:function(a){a.close()}}],initialize:function(){var a=JSON.stringify({a:3});$("#field-file-export-map").val(a)}}),b.createSwitchModeHandler(".btn-tool",{"btn-tool-pen":"pen","btn-tool-fill":"fill","btn-tool-eraser":"eraser"},function(a){d.setTool(a)}),b.createSwitchModeHandler(".btn-layer",{"btn-layer-bg":"bg","btn-layer-fg":"fg","btn-layer-event":"event"},function(a){c.setLayer(a)})},j=function(){i(),g(),h()};return{init:j}}),ac["export"]("dialog",function(a){"use strict";var b={elem:void 0,open:function(){this.elem.show()},close:function(){this.elem.hide()}},c=function(a,b){for(var c="",d=function(b,c){a.elem.on("click","#"+c,function(){b.action(a)})},e=0;e<b.length;e++){var f=b[e],g="btn-"+f.title.replace(/\s+/g,"-").toLowerCase();c+='<button id="'+g+'">'+f.title+"</button>",d(f,g)}return c};return{modal:function(a,d,e){var f=$.extend(!0,{},b),g=f.elem=$($("#tpl-dialog-overlay").html());return g.find(".btn-close").on("click",function(){f.close()}),g.find(".dialog-titlebar .title").html(a),g.find(".dialog-content").html(d),g.find(".dialog-button-panel").html(c(f,e)),$(document).on("keydown",function(a){a.which==ac.ESC_KEY&&f.close()}),$("body").append(g),f},confirm:function(a,b){var c=this;this.open("","<p>"+a+"</p>",[{title:"OK",action:function(){b(),c.close()}},{title:"Cancel",action:function(){c.close()}}])}}}),ac["export"]("pallette",function(){"use strict";var a=ac["import"]("graphics");return{init:function(b,c){var d,e=c||{},f=ac.TILESIZE,g=$(b),h="menu-tile-selected",i=[];a.loadImage(e.srcImage,function(b,c,j){for(var k=Math.floor(c/f),l=Math.floor(j/f),m=0,n=0;l>n;n++)for(var o=0;k>o;o++){var p=a.createCanvas(f,f);p.draw(b,o*f,n*f,0,0),i.push(p),p.elem.addClass("menu-tile").data("tilecode",m++),g.append(p.elem)}g.on("click",".menu-tile",function(){var a,b=$(this);d&&d.removeClass(h),b.addClass(h),d=b,a=Number(b.data("tilecode")),e.action(i[a].elem.get(0))}).find(".menu-tile:first").trigger("click")})}}}),ac["export"]("tools",function(){var a;return{setTool:function(){},initTools:function(){a={pen:function(a){},fill:function(a){},eraser:function(a){}}}}}),ac["export"]("widget",function(){"use strict";var a=ac["import"]("dialog");return{createDialogHandler:function(b){var c=b||{},d=$(c.templateSelector).html(),e=a.modal(c.title,$(d),c.buttonSet);$(c.btnSelector).on("click",function(){e.open(),$.isFunction(c.initialize)&&c.initialize()})},createSwitchModeHandler:function(a,b,c){var d="active",e=$(a);e.on("click",function(a){e.removeClass(d);var f=$(this),g=f.attr("id"),h=b[g];f.addClass(d),c(h)}),e.first().trigger("click")}}}),function(){"use strict";var a=ac["import"]("interface");a.init()}();