/*! Acrilic 25-11-2015 */
var AC=function(){"use strict";return window.log=console.log.bind(console),{ESC_KEY:27,TILESIZE:64,init:function(){}}}();AC.Dialog=function(){"use strict";var a=[],b=function(a,b){for(var c="",d=0;d<b.length;d++){var e=b[d],f="btn-"+e.title.replace(/\s+/g,"-").toLowerCase();c+='<button id="'+f+'">'+e.title+"</button>",a.on("click","#"+f,e.action)}return c};return{close:function(){var b=a.pop();b.remove()},open:function(c,d,e){var f=this,g=$($("#tpl-dialog-overlay").html()),h=g.find(".dialog-content"),i=g.find(".dialog-button-panel");0===a.length&&g.addClass("dim"),g.find(".btn-close").on("click",function(){f.close()}),g.find(".dialog-titlebar .title").html(c),h.html(d),i.html(b(g,e)),g.appendTo("body").show(),a.push(g)},confirm:function(a,b){var c=this;this.open("","<p>"+a+"</p>",[{title:"OK",action:function(){b(),c.close()}},{title:"Cancel",action:function(){c.close()}}])},alert:function(a,b){var c=this;this.open("","<p>"+a+"</p>",[{title:"OK",action:function(){c.close()}}])}}}(),AC.Editor=function(){"use strict";var a,b=[];return{currentTool:"",setMap:function(c){b.push(c),a=c}}}(),AC.Graphics=function(){var a={draw:function(a,b,c){var d=this.width,e=this.height;this.ctx.drawImage(a,b,c,d,e,0,0,d,e)}};return{loadImage:function(a,b){var c=new Image;c.onload=function(){b(c,c.width,c.height)},c.src=a},createCanvas:function(b,c){var d=$.extend(!0,{},a),e=$("<canvas/>").attr("width",b).attr("height",c);return d.width=b,d.height=c,d.ctx=e.get(0).getContext("2d"),d.elem=e,d}}}(),AC.Input=function(){"use strict";var a,b=function(a,b){return a?{status:!0}:{status:!1,msg:b}},c={type:function(a,c){return b(typeof c===a,"Expected a "+a+" type.")},min:function(a,c){return"string"==typeof c?b(c.length>=a,"Input length must be greater or equal than "+a+" characters."):"number"==typeof c?b(Number(c)>=a,"Input must be greater or equal than "+a+"."):{status:!1,msg:"Wrong data type!"}},max:function(a,c){return"string"==typeof c?b(c.length<=a,"Input length must be less or equal than "+a+" characters."):"number"==typeof c?b(Number(c)<=a,"Input must be less or equal than "+a+"."):{status:!1,msg:"Wrong data type!"}}};return{validate:function(b,d){var e=$(b),f=$.trim(e.val());for(var g in d){var h=d[g],i=c[g],j=i(h,f);return a.alert(j.msg),j.status}},init:function(b){a=b.dialog}}}(),AC.Interface=function(){"use strict";return $(document).on("keydown",function(a){a.which==AC.ESC_KEY&&self.Dialog.close()}),{createDialogHandler:function(a){var b=this,c=a||{},d=$(c.templateSelector).html();$(c.btnSelector).on("click",function(){b.Dialog.open(c.title,$(d),c.buttonSet),c.initialize&&"function"==typeof c.initialize&&c.initialize()})},createSwitchModeHandler:function(a,b){var c="active",d=$(a);d.on("click",function(a){d.removeClass(c);var e=$(this),f=e.attr("id");b[f];e.addClass(c)}),d.first().trigger("click")},createTilesetPalette:function(a,b){var c,d=this,e=AC.TILESIZE,f=$(a),g="menu-tile-selected";this.Graphics.loadImage(b.srcImage,function(a,b,h){for(var i=Math.floor(b/e),j=Math.floor(h/e),k=0;j>k;k++)for(var l=0;i>l;l++){var m=d.Graphics.createCanvas(e,e);m.draw(a,l*e,k*e),m.elem.addClass("menu-tile").data("tilecode",0),f.append(m.elem)}f.on("click",".menu-tile",function(){var a=$(this);c&&c.removeClass(g),a.addClass(g),c=a}).find(".menu-tile:first").trigger("click")})},createMapEditor:function(a,b){var c=this,d=$(a),e=AC.TILESIZE,f={x:0,y:0,dragging:!1},g=$("<div/>").addClass("selection-cursor").css({width:e,height:e});d.append(g),d.on("mousemove",function(a){var b=d.offset().left,h=d.offset().top,i=d.scrollLeft()+$(document).scrollLeft(),j=d.scrollTop()+$(document).scrollTop(),k=a.clientX-b+i,l=a.clientY-h+j;k=0>k?0:k,l=0>l?0:l,f.x=parseInt(k/e),f.y=parseInt(l/e),g.css("left",f.x*e),g.css("top",f.y*e),f.dragging&&c.setTile()}),d.on("mousedown",function(a){a.preventDefault(),f.dragging=!0}),$(document).on("mouseup",function(){f.dragging=!1})},build:function(a){return this.Graphics=a.graphics,this.Dialog=a.dialog,$("#map-panel").css("left",$("#tileset-panel-wrapper").width()),this}}}(),AC.Map=function(){var a={name:"",grid:[],setTile:function(){}};return{create:function(b,c,d){var e=$.extend(!0,{},a);e.name=b;for(var f=0;d>f;f++){e.grid.push([]);for(var g=0;c>g;g++)e.grid[f].push({id:0})}return e}}}(),function(){"use strict";AC.init(),AC.Input.init({dialog:AC.Dialog}),AC.Interface.build({graphics:AC.Graphics,dialog:AC.Dialog}),AC.Interface.createDialogHandler({title:"New map",btnSelector:"#btn-file-new",templateSelector:"#tpl-dialog-file-new",buttonSet:[{title:"OK",action:function(){var a=AC.Input.validate("#field-file-new-name",{min:1,max:120,type:"string"}),b=AC.Input.validate("#field-file-new-width",{min:1,max:40,type:"number"}),c=AC.Input.validate("#field-file-new-height",{min:1,max:40,type:"number"}),d=AC.Map.create(a,b,c);AC.Editor.setMap(d),AC.Dialog.close()}},{title:"Cancel",action:function(){AC.Dialog.close()}}]}),AC.Interface.createDialogHandler({title:"Import",btnSelector:"#btn-file-import",templateSelector:"#tpl-dialog-file-import",buttonSet:[{title:"Import",action:function(){$("#field-file-import-map").val()}},{title:"Cancel",action:function(){AC.Dialog.close()}}]}),AC.Interface.createDialogHandler({title:"Export",btnSelector:"#btn-file-export",templateSelector:"#tpl-dialog-file-export",buttonSet:[{title:"Close",action:function(){AC.Dialog.close()}}],initialize:function(){var a=JSON.stringify({a:3});$("#field-file-export-map").val(a)}}),AC.Interface.createSwitchModeHandler(".btn-tool",{"btn-tool-pen":"pen","btn-tool-fill":"fill","btn-tool-eraser":"eraser"}),AC.Interface.createSwitchModeHandler(".btn-layer",{"btn-layer-bg":"bg","btn-layer-fg":"fg","btn-layer-event":"event"}),AC.Interface.createTilesetPalette("#tileset-panel",{srcImage:"tilesets/ground-layer.png"}),AC.Interface.createMapEditor("#map-panel")}();